import click
from rich.console import Console
from rich.table import Table
from rich.panel import Panel
from cassino_cli.utils.deck import new_shuffled_deck, hand_value, format_hand

console = Console()

def _deal_card(deck):
    if not deck:
        deck.extend(new_shuffled_deck(4))
    return deck.pop()

def _get_player_action():
    while True:
        escolha = click.prompt("AÃ§Ã£o (h = hit, s = stand, d = double) ", default="h").lower()
        if escolha in ['h', 's', 'd']:
            return escolha
        console.print("[red]OpÃ§Ã£o invÃ¡lida. Tente novamente.[/red]")

def _dealer_play(dealer, deck):
    while hand_value(dealer) < 17 or (hand_value(dealer) == 17 and any(r == "A" for r, _ in dealer)):
        dealer.append(_deal_card(deck))

def play_blackjack(saldo_inicial: int, aposta: int):
    saldo = saldo_inicial
    deck = new_shuffled_deck(4)

    while saldo >= aposta:
        console.rule("[bold]Blackjack[/bold]")
        console.print(f"Saldo: [bold]${saldo}[/bold] | Aposta: [bold]${aposta}[/bold]")

        player = [_deal_card(deck), _deal_card(deck)]
        dealer = [_deal_card(deck), _deal_card(deck)]

        while True:
            table = Table(title="Mesa")
            table.add_column("Jogador", justify="left")
            table.add_column("Dealer", justify="left")
            table.add_row(
                f"{format_hand(player)}  (valor: {hand_value(player)})",
                f"[{dealer[0][0]}{dealer[0][1]}] [??]  (parcial)"
            )
            console.print(table)

            if hand_value(player) == 21:
                console.print(Panel.fit("Blackjack! ðŸ¥³ VocÃª ganhou 1.5x", style="green"))
                ganho = int(aposta * 1.5)
                saldo += ganho
                break

            escolha = _get_player_action()

            if escolha == "h":
                player.append(_deal_card(deck))
                if hand_value(player) > 21:
                    console.print(Panel.fit("Estourou! ðŸ˜µ VocÃª perdeu.", style="red"))
                    saldo -= aposta
                    break
            elif escolha == "d" and saldo >= aposta * 2:
                aposta *= 2
                console.print(f"Aposta dobrada para ${aposta}.")
                player.append(_deal_card(deck))
                if hand_value(player) > 21:
                    console.print(Panel.fit("Estourou apÃ³s dobrar! ðŸ˜µ", style="red"))
                    saldo -= aposta
                    break
            elif escolha == "s":
                break

            _dealer_play(dealer, deck)

            pv, dv = hand_value(player), hand_value(dealer)
            mesa_final = Table(title="Resultado")
            mesa_final.add_column("Jogador")
            mesa_final.add_column("Dealer")
            mesa_final.add_row(
                f"{format_hand(player)}  (valor: {pv})",
                f"{format_hand(dealer)}  (valor: {dv})"
            )
            console.print(mesa_final)

            if dv > 21 or pv > dv:
                console.print(Panel.fit("VocÃª venceu! ðŸŽ‰", style="green"))
                saldo += aposta
            elif pv < dv:
                console.print(Panel.fit("Dealer venceu. ðŸ˜”", style="red"))
                saldo -= aposta
            else:
                console.print(Panel.fit("Empate (push).", style="yellow"))

            break

        if saldo < 1:
            console.print(Panel.fit("Saldo zerado. Fim de jogo.", style="red"))
            break

        again = click.confirm("Jogar outra rodada?", default=True)
        if not again:
            break

    console.print(Panel.fit(f"Saldo final: ${saldo}", style="cyan"))
